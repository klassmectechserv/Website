import { defineEventHandler } from "h3";
import { queryCollection } from "@nuxt/content/server";
import manifest from "#content/manifest";
import { filters } from "#sitemap/content-filters";
import { onUrlFns } from "#sitemap/content-on-url";
export default defineEventHandler(async (e) => {
  const collections = [];
  for (const collection in manifest) {
    if (manifest[collection].fields.sitemap)
      collections.push(collection);
  }
  const contentList = [];
  for (const collection of collections) {
    const needsAllFields = filters?.has(collection) || onUrlFns?.has(collection);
    const query = queryCollection(e, collection).where("path", "IS NOT NULL").where("sitemap", "IS NOT NULL");
    if (!needsAllFields)
      query.select("path", "sitemap");
    contentList.push(
      query.all().then((results2) => {
        const filter = filters?.get(collection);
        return { collection, entries: filter ? results2.filter(filter) : results2 };
      })
    );
  }
  const results = await Promise.all(contentList);
  return results.flatMap(({ collection, entries }) => {
    const onUrl = onUrlFns?.get(collection);
    return entries.filter((c) => c.sitemap !== false && c.path).map((c) => {
      const url = {
        loc: c.path,
        ...typeof c.sitemap === "object" ? c.sitemap : {}
      };
      onUrl?.(url, c, collection);
      return url;
    });
  }).filter(Boolean);
});
